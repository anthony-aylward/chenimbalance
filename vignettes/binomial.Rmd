---
title: "Weighted expected binomial model"
author: "Anthony Aylward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Prepare the data.

```{r}
library(chenimbalance)
total_reads <- rowSums(accb[, c("cA", "cC", "cG", "cT")])
data <- data.frame(
  total = total_reads,
  allelicRatio = sapply(
    1:nrow(accb),
    function(i) {
      accb[[paste("c", accb[["ref"]][[i]], sep = "")]][[i]] / total_reads[[i]]
    }
  )
)
head(data)
```

## Binomial distribution

```{r}
# graded weights for SSE calculation
binSize <- 40
bins <- pretty(0:1, binSize)

# empirical allelic Ratio
minN <- 6
maxN <- min(2500, max(data[["total"]]))
apropor <- length(data[["total"]][data[["total"]] <= 2500]) / nrow(data)
empirical <- empirical_allelic_ratio(
  data,
  bins,
  maxN = maxN,
  minN = minN,
  plot = TRUE
)
```

Plot the empirical and weighted expected binomial distributions

Weighted expected binomial 

Plot the binomial distribution for each n

`dbinom(seq(0,500),n=500,p=0.5)` gives the pdf of 0-500, at `n=500`, `p=0.5` in
binomial distrib

weight each probability by the number of SNPs with n reads

Compute the sum of squared errors for the binomial distribution.

weighted betabinomial distribution
very naive way of automating the process of finding b parameter automatically
using least sum of squares of errors (between the density plots of empirical 
and the expected distributions)

```{r}
w <- weight_by_empirical_counts(data[["total"]])
d.combined.sorted.binned <- nulldistrib(
  w,
  minN = minN,
  binSize = binSize
)
yuplimit <- 0.15
barplot(
  empirical,
  ylim = c(0, yuplimit),
  ylab = "density", 
  xlab = "allelicRatio",
  names.arg = bins[2:length(bins)] - bins[[2]] / 2,
  main = paste("n=", minN, "-", maxN)
)
par(new = TRUE)
plot(
  d.combined.sorted.binned,
  ylim = c(0, yuplimit),
  pch=16,
  type='b',
  col='red',
  bty='n',
  ylab='',
  xlab='',
  yaxt='n',
  xaxt='n',
  yaxs="i"
)
sse <- sum((empirical - d.combined.sorted.binned[,2])^2)
w_grad <- graded_weights_for_sse_calculation(r_min = 0, r_max = 1, bins = bins)
overdispersion_details <- choose_overdispersion_parameter(
  w_grad,
  w,
  empirical,
  sse
)
par(new = TRUE)
colors <- color_palette()
plot(
  overdispersion_details[["e_combined_sorted_binned"]],
  ylim = c(0, yuplimit),
  pch = 16,
  type = 'b',
  col = colors[[2]],
  bty = 'n',
  ylab = '',
  xlab = '',
  yaxt = 'n',
  xaxt = 'n',
  yaxs = "i"
)
```
